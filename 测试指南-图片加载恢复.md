# 图片加载恢复功能 - 测试指南

## 问题描述

当图片生成完成，正在从服务器回传下载（渐进式加载）时，如果网络暂时断开：
- 图片只加载了一半（浏览器的渐进式 JPEG 加载）
- 即使重连后，图片也不会自动重新加载
- 导致永久显示半张图片

## 解决方案

### 1. 自动重试机制

- **检测失败**: 监听 `<img>` 标签的 `onError` 事件
- **自动重试**: 最多重试 3 次，每次延迟递增（1秒、2秒、3秒）
- **加载成功**: 监听 `onLoad` 事件，清除错误状态

### 2. 连接恢复时重新加载

当连接状态从 `disconnected` 恢复为 `connected` 时：
- 自动扫描所有加载失败的图片
- 重置重试计数
- 随机延迟后重新加载（避免同时请求太多）

### 3. 实现细节

**新增字段** (在占位符中):
```javascript
imageLoadError: false,  // 图片加载是否失败
imageRetryCount: 0      // 图片加载重试次数
```

**核心函数**:
- `handleImageError(placeholderId)`: 处理图片加载失败
- `retryImageLoad(placeholderId)`: 重试加载图片（添加时间戳防止缓存）
- `handleImageLoad(placeholderId)`: 处理图片加载成功
- `reloadFailedImages()`: 重新加载所有失败的图片

**触发时机**:
1. 图片加载失败时 → 自动重试（最多 3 次）
2. 连接恢复时（`checkConnection` 成功）→ 重新加载所有失败图片
3. 生成任务收到 ComfyUI 消息时（连接自动恢复）→ 重新加载所有失败图片

---

## 测试步骤

### 测试场景 1: 图片加载中途断开

**步骤**:
1. 启动 ComfyUI 和后端
2. 打开前端，发起生成任务（batchSize=5）
3. 等待第一张图片生成完成，开始加载时（可以看到图片从上往下渐进加载）
4. **立即停止后端**（`pm2 stop corinegen-backend`）
5. 观察图片是否只加载了一半

**预期结果**:
- ✅ 图片加载失败后，**1 秒后自动重试**
- ✅ 如果仍然失败，**2 秒后再次重试**
- ✅ 最多重试 3 次
- ✅ 浏览器控制台显示重试日志：`[handleImageError] 图片加载失败，准备重试 (X/3)`

---

### 测试场景 2: 重连后自动恢复图片

**步骤**:
1. 启动 ComfyUI 和后端
2. 打开前端，发起生成任务（batchSize=10）
3. 等待 3 张图片生成完成
4. 在第 4 张图片加载过程中，**停止后端**
5. 观察第 4 张图片是否只加载了一半
6. 等待重试 3 次失败后，**重启后端**（`pm2 restart corinegen-backend`）
7. 等待连接自动恢复（绿色横幅显示"已重新连接到 ComfyUI"）

**预期结果**:
- ✅ 停止后端后，第 4 张图片重试 3 次后停止
- ✅ 重启后端后，连接恢复时自动重新加载第 4 张图片
- ✅ 第 4 张图片完整加载（不再只有一半）
- ✅ 浏览器控制台显示：`[reloadFailedImages] 重新加载 1 张失败的图片`

---

### 测试场景 3: 多张图片同时加载失败

**步骤**:
1. 启动 ComfyUI 和后端
2. 打开前端，使用**批次模式**发起生成（batchSize=5）
3. 批次模式会一次性生成 5 张图片
4. 等待所有图片生成完成，**在图片开始加载时立即停止后端**
5. 观察多张图片是否同时加载失败
6. **重启后端**
7. 等待连接恢复

**预期结果**:
- ✅ 多张图片同时加载失败
- ✅ 每张图片各自重试 3 次（可能间隔不同）
- ✅ 重连后，所有失败的图片自动重新加载
- ✅ 浏览器控制台显示：`[reloadFailedImages] 重新加载 X 张失败的图片`
- ✅ 图片重新加载时有随机延迟（0-500ms），避免同时请求

---

### 测试场景 4: 网络不稳定时的表现

**步骤**:
1. 启动 ComfyUI 和后端
2. 打开前端，发起生成任务（batchSize=10）
3. 在生成过程中，**多次快速停止/重启后端**（模拟网络抖动）
4. 观察图片加载情况

**预期结果**:
- ✅ 即使网络不稳定，图片最终也能完整加载
- ✅ 重试机制能正确处理多次失败
- ✅ 连接恢复时能自动修复所有失败的图片

---

## 验证要点

### ✅ 功能验证

1. **自动重试**: 图片加载失败后自动重试，无需手动刷新
2. **递增延迟**: 重试间隔为 1s、2s、3s（递增）
3. **最大重试次数**: 最多重试 3 次，避免无限重试
4. **连接恢复**: 重连后自动扫描并重新加载失败图片
5. **防止缓存**: 重新加载时添加时间戳参数 `?t=timestamp`
6. **状态清理**: 加载成功后清除错误状态和重试计数

### ⚠️ 边缘情况

1. **正在重试时重连**: 连接恢复会重置重试计数，给图片新的 3 次机会
2. **高清图片加载失败**: 同样适用于高清化后的图片（`hqImageUrl`）
3. **多张图片同时失败**: 随机延迟加载，避免同时请求造成拥堵

---

## 技术实现

### 关键代码位置

| 功能 | 文件 | 行号 |
|------|------|------|
| 占位符字段定义 | App.jsx | 996-997, 1189-1190 |
| 图片错误处理 | App.jsx | 2372-2403 |
| 图片重试加载 | App.jsx | 2405-2422 |
| 图片加载成功 | App.jsx | 2424-2434 |
| 重新加载失败图片 | App.jsx | 2436-2461 |
| 连接恢复时调用 | App.jsx | 633-635 |
| 生成时连接恢复 | App.jsx | 1285, 1304, 1536, 1557, 1813, 1838 |
| img 标签事件 | App.jsx | 3695-3696 |

### 日志输出

**浏览器控制台**:
- `[handleImageError] 图片加载失败，准备重试 (X/3): placeholder-id`
- `[retryImageLoad] 重试加载图片: placeholder-id`
- `[handleImageError] 图片加载失败，已达最大重试次数: placeholder-id`
- `[reloadFailedImages] 重新加载 X 张失败的图片`

---

## 预期改进效果

### 用户体验提升

| 场景 | 旧版本 | 新版本 |
|------|--------|--------|
| 图片加载中断开 | ❌ 永久显示半张图片 | ✅ 自动重试 3 次 |
| 重连后 | ❌ 图片仍然是半张 | ✅ 自动重新加载完整图片 |
| 网络不稳定 | ❌ 多张图片半加载 | ✅ 全部自动恢复 |
| 用户操作 | ❌ 需要手动刷新页面 | ✅ 完全自动化，无需干预 |

### 技术改进

- ✅ 智能重试：递增延迟 + 最大次数限制
- ✅ 防止缓存：URL 添加时间戳参数
- ✅ 批量恢复：连接恢复时扫描所有失败图片
- ✅ 错误隔离：每张图片独立重试，互不影响
- ✅ 性能优化：随机延迟避免同时请求

---

## 部署说明

**前端（Vercel）**:
- 推送到 GitHub 后自动部署
- 预计 2-3 分钟完成

**后端（本机）**:
- 无需更新，后端代码未修改

**测试环境**:
- 开发环境（localhost:5173）：无需额外操作
- 生产环境（Vercel）：等待自动部署完成

---

## 反馈

如果测试过程中发现任何问题，请记录：

1. **场景描述**: 你在做什么操作
2. **预期行为**: 应该发生什么
3. **实际行为**: 实际发生了什么
4. **浏览器控制台日志**: 重试和恢复的日志信息
5. **图片状态**: 哪些图片加载失败，哪些成功恢复

---

**测试愉快！🎉**

最后更新：2026-01-18
