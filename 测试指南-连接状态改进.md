# 连接状态改进 - 测试指南

## 改进内容概述

### 问题 1：多设备队列机制（已解答）

✅ **结论**：这不是巧合，而是 **ComfyUI FIFO 队列** + **循环模式逐张提交** + **网络延迟** 共同作用的结果。

📄 详细说明已写入：`docs/multi-device-queue.md`

**简单来说**：
- 每个设备使用循环模式时，每次只提交一个任务
- 所有设备的任务进入 ComfyUI 的同一个 FIFO 队列
- 在等待上一个任务完成的时间里，其他设备有机会插入任务
- 因此看起来像"交替执行"

---

### 问题 2：连接状态横幅显示错误（已修复）

✅ **修复内容**：

1. **智能状态恢复**：
   - 当生成任务收到任何 ComfyUI 消息（execution_start 或 progress）时
   - 自动将连接状态从 'disconnected' 恢复为 'connected'
   - 显示绿色横幅："已重新连接到 ComfyUI"
   - 3 秒后自动收起

2. **忽略生成期间的心跳失败**：
   - 如果正在生成（`isGenerating === true`）
   - 心跳检测失败时不显示"无法连接"横幅
   - 因为生成任务有自己的 WebSocket 连接，不依赖心跳

3. **改进的重连提示**：
   - 首次连接：显示"ComfyUI 连接成功，一切就绪"
   - 重新连接：显示"已重新连接到 ComfyUI"

---

## 测试步骤

### 测试场景 1：生成中途心跳检测失败

**目的**：验证生成过程中不再显示误导性的"无法连接"提示

**步骤**：
1. 启动 ComfyUI 和后端
2. 打开前端，确认连接成功
3. 发起一个批量生成任务（batchSize=5 或更多）
4. 在生成过程中，**暂时停止 ComfyUI**（或断开网络 5-10 秒）
5. 等待心跳检测（5 秒内）触发

**预期结果**：
- ❌ 旧版本：显示"无法连接到 ComfyUI，请确保服务已启动"红色横幅
- ✅ 新版本：**不显示**任何错误横幅，生成任务继续进行

**原因**：生成任务使用独立的 WebSocket 连接，心跳检测失败不影响生成

---

### 测试场景 2：生成中途实际断开并恢复

**目的**：验证自动状态恢复功能

**步骤**：
1. 启动 ComfyUI 和后端
2. 打开前端，确认连接成功
3. 发起一个批量生成任务（batchSize=5）
4. 在生成第 2 张时，**完全停止后端**（`pm2 stop corinegen-backend`）
5. 观察横幅提示（应该显示"生成已暂停"对话框）
6. 重启后端（`pm2 restart corinegen-backend`）
7. 等待生成任务的 WebSocket 重连并收到下一个 execution_start 或 progress 消息

**预期结果**：
- ✅ 停止后端时：显示"⏸ 生成已暂停"对话框
- ✅ 重启后端后：当收到第一个 ComfyUI 消息时，绿色横幅自动显示"已重新连接到 ComfyUI"
- ✅ 3 秒后：横幅自动收起
- ✅ 连接状态指示器：变为绿色（已连接）

---

### 测试场景 3：手动点击重新连接

**目的**：验证手动重连的提示区分

**步骤**：
1. 停止 ComfyUI
2. 打开前端（会显示"无法连接到 ComfyUI"）
3. 启动 ComfyUI
4. 点击横幅上的"重新连接"按钮

**预期结果**：
- ✅ 首次打开时：显示"无法连接到 ComfyUI，请确保服务已启动"（红色）
- ✅ 点击重新连接后：显示"已重新连接到 ComfyUI"（绿色）
- ✅ 3 秒后：横幅自动收起

---

### 测试场景 4：多设备交替生成（可选）

**目的**：验证多设备队列机制文档的准确性

**步骤**：
1. 打开两个浏览器窗口（或两个设备）访问 CorineGen
2. 设备 A：设置 batchSize=5，发起生成
3. 设备 B：立即设置 batchSize=3，发起生成
4. 观察生成顺序

**预期结果**：
- ✅ 生成顺序类似：A-1 → B-1 → A-2 → B-2 → A-3 → B-3 → A-4 → A-5
- ✅ 看起来像"一个设备一张"交替执行
- ✅ 实际上是 ComfyUI FIFO 队列的自然结果

---

## 关键验证点

### ✅ 必须验证的功能

1. **生成过程中心跳失败不显示错误**
   - 心跳检测每 5 秒一次
   - 如果 `isGenerating === true`，心跳失败不影响 UI

2. **自动状态恢复**
   - 收到任何 execution_start 或 progress 消息
   - 自动设置 `connectionStatus = 'connected'`
   - 显示"已重新连接到 ComfyUI"绿色横幅

3. **3 秒自动收起**
   - 所有连接成功的横幅都在 3 秒后自动消失

### ⚠️ 边缘情况

1. **同时收到多个 progress 消息**
   - 状态恢复逻辑只在第一次触发
   - 不会重复显示横幅（通过 `connectionStatus !== 'connected'` 检查）

2. **心跳检测和生成消息竞争**
   - 如果心跳检测在生成消息之前完成，也能正确恢复
   - 不会出现状态闪烁

---

## 预期改进效果

### 用户体验提升

| 场景 | 旧版本 | 新版本 |
|------|--------|--------|
| 生成中心跳失败 | ❌ 显示"无法连接"红色横幅 | ✅ 不显示错误，生成继续 |
| 生成中实际断开并恢复 | ❌ 显示"无法连接"，需手动点重连 | ✅ 自动显示"已重新连接"绿色横幅 |
| 手动重连 | ⚠️ 提示不明确 | ✅ 明确显示"已重新连接" |
| 首次连接 | ⚠️ 提示相同 | ✅ 显示"连接成功，一切就绪" |

### 技术改进

- ✅ 消除心跳检测和生成连接的状态冲突
- ✅ 利用 ComfyUI 消息作为连接存活的证据
- ✅ 更智能的状态管理，减少误报

---

## 部署说明

**前端（Vercel）**：
- 推送到 GitHub 后自动部署
- 预计 2-3 分钟完成

**后端（本机）**：
- 无需更新，后端代码未修改

**测试环境**：
- 开发环境（localhost:5173）：无需额外操作
- 生产环境（Vercel）：等待自动部署完成

---

## 文档补充

新增文档：`docs/multi-device-queue.md`

**内容涵盖**：
- 多设备队列的工作原理
- 为什么会"交替执行"
- 前端队列 vs WebSocket 层 vs ComfyUI 队列
- 时间交错的详细分析
- 批次模式 vs 循环模式的区别
- 架构优势和改进建议

建议阅读以深入理解队列机制！

---

## 反馈

如果测试过程中发现任何问题，请记录以下信息：

1. **场景描述**：你在做什么操作
2. **预期行为**：应该发生什么
3. **实际行为**：实际发生了什么
4. **浏览器控制台日志**：是否有错误或警告
5. **连接状态**：横幅显示的内容

---

**测试愉快！🎉**

最后更新：2026-01-17
